#!/usr/bin/env bash
#
# The `setup` in the root directory will use these functions on debian.
# It doesn't do anything when executed directly.

function configure_bash {
  sudo apt-get install -y bash-completion
  rsync -av "$ROOT/dotfiles/.bashrc" ~/.bashrc
  rsync -av --delete "$ROOT/dotfiles/.config/bashrc/" "$XDG_CONFIG_HOME/bashrc/"
}

function configure_docker {
  local docker_version docker_compose_version
  docker_version=$(get_latest_release "moby/moby")
  docker_compose_version=$(get_latest_release "docker/compose")

  log_info "Installing Docker $docker_version."
  curl -fsSL https://get.docker.com | sudo sh
  log_info "Installed Docker $docker_version"

  log_info "Installing Docker Compose $docker_compose_version"
  sudo mkdir -p /usr/local/lib/docker/cli-plugins
  sudo curl -fsSL "https://github.com/docker/compose/releases/download/${docker_compose_version}/docker-compose-$(uname -s)-$(uname -m)" \
    -o /usr/local/lib/docker/cli-plugins/docker-compose
  sudo chmod +x /usr/local/lib/docker/cli-plugins/docker-compose
  log_info "Installed Docker Compose $docker_compose_version"

  log_info "Adding $USER to docker group"
  create_group docker
  add_user_to_group $USER docker
  log_info "User added to docker group, relog or use 'exec sudo su -l \$USER' to access docker"

  log_info "Starting and enabling docker"
  sudo systemctl enable docker --now
}

function configure_vim {
  log_info "Installing vim."
  sudo apt-get install -y vim

  mkdir -p ~/.vim/autoload ~/.vim/bundle

  log_info "Setting up vim addon manager (pathogen)."

  curl -LSso ~/.vim/autoload/pathogen.vim https://raw.githubusercontent.com/tpope/vim-pathogen/master/autoload/pathogen.vim

  log_info "Cloning vim addons."

  get_latest_git https://github.com/vim-airline/vim-airline.git ~/.vim/bundle/airline
  get_latest_git https://github.com/tpope/vim-fugitive.git ~/.vim/bundle/fugitive
  get_latest_git https://github.com/mhinz/vim-signify.git ~/.vim/bundle/vim-signify
  get_latest_git https://github.com/morhetz/gruvbox.git ~/.vim/bundle/gruvbox

  rsync -av "$ROOT/dotfiles/.vimrc" ~/.vimrc
}

function configure_tmux {
  sudo apt-get install -y tmux
  rsync -av --delete "$ROOT/dotfiles/.config/tmux/" "$XDG_CONFIG_HOME/tmux/"
}
