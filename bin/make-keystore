#!/usr/bin/env bash
#
# Usage: make-keystore <service> <hostname1> [hostname2 ...] [--outdir DIR]

THIS=$(realpath "$0")
HERE=$(dirname "$THIS")

source "$HERE/lib/logging.sh"

# -----------------------------------------------------
# Parsing args
# -----------------------------------------------------

# Defaults
OUTDIR="$PWD"

while [[ $# -gt 0 ]]; do
  case "$1" in
    --outdir|-o) OUTDIR="$2"; shift 2;;
    --) shift; while [[ $# -gt 0 ]]; do POSITIONAL_ARGS+=("$1"); shift; done;;
    -*) log_error "Unknown option: $1"; exit 1;;
    *) POSITIONAL_ARGS+=("$1"); shift;;
  esac
done

set -- "${POSITIONAL_ARGS[@]}"

SERVICE="$1"
shift 1
HOSTS=("$@")

# -----------------------------------------------------
# Main
# -----------------------------------------------------

mkdir -p "$OUTDIR"

KEY_FILE="${OUTDIR}/${SERVICE}.key"
CRT_FILE="${OUTDIR}/${SERVICE}.crt"
P12_FILE="${OUTDIR}/${SERVICE}.p12"
JKS_FILE="${OUTDIR}/${SERVICE}.jks"

make-cert "$SERVICE" "$OUTDIR" "${HOSTS[@]}"

log_info "Creating PKCS12 bundle..."
openssl pkcs12 -export \
  -in "$CRT_FILE" \
  -inkey "$KEY_FILE" \
  -name "$SERVICE" \
  -out "$P12_FILE" \
  -passout pass:changeit

log_info "Creating JKS keystore..."
keytool -importkeystore \
  -destkeystore "$JKS_FILE" \
  -deststorepass changeit \
  -srckeystore "$P12_FILE" \
  -srcstoretype PKCS12 \
  -srcstorepass changeit \
  -alias "$SERVICE"

rm -f "$P12_FILE"

log_info "Keystore: $JKS_FILE"
