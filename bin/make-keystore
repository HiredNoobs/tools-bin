#!/usr/bin/env bash
#
# Usage: make-keystore <service> <hostname1> [hostname2 ...] [--outdir DIR] [--ca-key FILE] [--ca-crt FILE]

THIS=$(realpath "$0")
HERE=$(dirname "$THIS")

source "$HERE/lib/logging.sh"

# -----------------------------------------------------
# Parsing args
# -----------------------------------------------------

OUTDIR="$PWD"

while [[ $# -gt 0 ]]; do
  case "$1" in
    --outdir|-o) OUTDIR="$2"; shift 2;;
    --ca-key) CA_KEY="$2"; shift 2;;
    --ca-crt) CA_CRT="$2"; shift 2;;
    --) shift; while [[ $# -gt 0 ]]; do POSITIONAL_ARGS+=("$1"); shift; done;;
    -*) log_error "Unknown option: $1"; exit 1;;
    *) POSITIONAL_ARGS+=("$1"); shift;;
  esac
done

set -- "${POSITIONAL_ARGS[@]}"

if [[ ! -v CA_KEY && ! -v CA_CRT ]]; then
  CA_KEY="${OUTDIR}/ca.key"
  CA_CRT="${OUTDIR}/ca.crt"
fi

SERVICE="$1"
shift 1
HOSTS=("$@")

# -----------------------------------------------------
# Main
# -----------------------------------------------------

mkdir -p "$OUTDIR"

KEY_FILE="${OUTDIR}/${SERVICE}.key"
CRT_FILE="${OUTDIR}/${SERVICE}.crt"
P12_FILE="${OUTDIR}/${SERVICE}.p12"
JKS_FILE="${OUTDIR}/${SERVICE}-keystore.jks"
PASS_FILE="${OUTDIR}/keystore.pass"

if [[ -f "$PASS_FILE" ]]; then
  KEYSTORE_PASS=$(<"${OUTDIR}/keystore.pass")
else
  KEYSTORE_PASS=$(openssl rand -base64 48 | tr -dc 'A-Za-z0-9' | head -c 32)
  echo "$KEYSTORE_PASS" > "$PASS_FILE"
fi

if [[ ! -f "$CA_KEY" || ! -f "$CA_CRT" ]]; then
  make-ca "$SERVICE" -o "$OUTDIR"
fi

make-cert "$SERVICE" "${HOSTS[@]}" \
  -o "$OUTDIR" \
  --ca-key "$CA_KEY" \
  --ca-crt "$CA_CRT"

log_info "Creating PKCS12 bundle..."
openssl pkcs12 -export \
  -in "$CRT_FILE" \
  -inkey "$KEY_FILE" \
  -name "$SERVICE" \
  -out "$P12_FILE" \
  -passout pass:"$KEYSTORE_PASS"

log_info "Creating JKS keystore..."
keytool -importkeystore \
  -destkeystore "$JKS_FILE" \
  -deststorepass "$KEYSTORE_PASS" \
  -srckeystore "$P12_FILE" \
  -srcstoretype PKCS12 \
  -srcstorepass "$KEYSTORE_PASS" \
  -alias "$SERVICE"

rm -f "$P12_FILE"

log_info "Keystore: $JKS_FILE"
