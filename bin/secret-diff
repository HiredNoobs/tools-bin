#!/usr/bin/env python3
#
# Takes a file path as an arg and reads a vault secret
# from stdin. The local secret files and the json
# vault secret are then compared.
#
# Prints out a line-by-line diff if there are changes.
#
# Usage:
# JSON | secret-diff <FILE PATH>


import argparse
import base64
import difflib
import json
import os
import sys
from pathlib import Path


def compare_vault_to_local(path: str, vault: dict[str, str | bytes]) -> str:
    output = ""

    for key, value in vault.items():
        b64 = False
        if key.endswith(".base64"):
            key = key[:-7]
            b64 = True

        try:
            with open(f"{path}/{key}", "rb") as file:
                buffer = file.read()
                if b64:
                    secret = base64.b64encode(buffer).decode("utf-8")
                else:
                    secret = buffer.decode("utf-8")
        except FileNotFoundError:
            secret = None

        if not secret:
            output += f"Secret {key} does not exist locally or file is empty.\n"
        elif value != secret:
            output += f"Value of {key} has changed.\n"
            if not b64:
                diff = difflib.ndiff(
                    value.splitlines(keepends=True), secret.splitlines(keepends=True)
                )
                output += "".join(diff)
                output += "\n"

    return output


def compare_local_to_vault(path: str, vault: dict[str, str | bytes]) -> str:
    output = ""
    for filename in os.listdir(path):
        filenames = [filename, f"{filename}.base64"]
        if not any(f in vault.keys() for f in filenames):
            output += f"Secret {filename} not in vault.\n"
    return output


def parse_args() -> argparse.Namespace:
    parser = argparse.ArgumentParser(
        description="Prints out a diff of the local secrets compared to those in Vault."
    )
    parser.add_argument("path", type=Path, help="Path to local secrets.")
    return parser.parse_args()


def main() -> None:
    args = parse_args()
    secret = json.load(sys.stdin)

    local_changes = compare_vault_to_local(args.path, secret)
    upstream_changes = compare_local_to_vault(args.path, secret)

    if not local_changes and not upstream_changes:
        print("No secrets have changed.")
    else:
        print(local_changes)
        print(upstream_changes)


if __name__ == "__main__":
    main()
