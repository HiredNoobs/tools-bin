#!/usr/bin/env bash

THIS=$(realpath "$0")
HERE=$(dirname "$THIS")

source $HERE/lib/logging.sh
source $HERE/lib/env

# -----------------------------------------------------
# Functions
# -----------------------------------------------------
function clean_docker_contexts {
  local contexts context
  contexts=$(docker context ls --format '{{ .Name }}' | grep -v 'default')
  
  [[ -z "$contexts" ]] && return 0

  log_info "Deleting contexts:"
  for context in $contexts; do
    docker context rm -f "$context"
  done
}

function create_context {
  local context_name context_hostname
  context_name="$1"
  context_hostname="$2"
  if [[ "$context_hostname" == "${HOSTNAME}.${DOMAIN}" ]]; then
    docker context create --from "default" --description "local" $context_name 2> /dev/null
  else
    docker context create --docker "host=ssh://${context_hostname}" $context_name 2> /dev/null
  fi
}

function configure_docker_contexts {
  clean_docker_contexts

  echo
  log_info "Creating contexts:"
  create_context "development.core"    "atlas.${DOMAIN}"
  create_context "production.core"     "prod-rsyslog001.${DOMAIN}"
  create_context "production.services" "prod-vault001.${DOMAIN}"
}

function install_vault_client {
  curl https://releases.hashicorp.com/vault/1.21.0/vault_1.21.0_linux_386.zip -o /tmp/vault.zip
  unzip -o /tmp/vault.zip -d /tmp/vault
  mv /tmp/vault/vault ~/tools-bin/bin/vault
  chmod +x ~/tools-bin/bin/vault
}

# -----------------------------------------------------
# Main
# -----------------------------------------------------

install_vault_client
configure_docker_contexts
