#!/usr/bin/env bash

# Removes all non-default docker contexts
function clean_docker_contexts {
  local contexts context_count
  contexts=$(docker context ls --format '{{ .Name }}' | grep -v 'default')
  context_count=$(echo $contexts | wc -w)
  if [[ $context_count -gt 0 ]]; then
    echo "Deleting contexts:"
    docker context rm $contexts
    echo
  fi
}

function create_context {
  local context_name context_hostname
  context_name="$1"
  context_hostname="$2"
  if [[ "$context_name" == $HOSTNAME ]]; then
    docker context create --from "default" --description "local" $context_name 2> /dev/null
  else
    docker context create --docker "host=ssh://${context_hostname}" $context_name 2> /dev/null
  fi
}

function configure_docker_contexts {
  clean_docker_contexts
  echo "Creating contexts:"
  create_context "development.core"    "altas"
  create_context "production.core"     "prod-rsyslog001"
  create_context "production.services" "prod-vault001"
}

function install_vault_client {
  curl https://releases.hashicorp.com/vault/1.21.0/vault_1.21.0_linux_386.zip -o /tmp/vault.zip
  unzip /tmp/vault.zip -d /tmp/vault
  mv /tmp/vault/vault ~/tools-bin/bin/vault
  chmod +x ~/tools-bin/bin/vault
}

# -----------------------------------------------------
# Main
# -----------------------------------------------------

install_vault_client
configure_docker_contexts
