#!/usr/bin/env bash
#
# Usage: make-ca <CN> [--outdir DIR]

THIS=$(realpath "$0")
HERE=$(dirname "$THIS")

source "$HERE/lib/logging.sh"

# -----------------------------------------------------
# Parsing args
# -----------------------------------------------------

OUTDIR="$PWD"

while [[ $# -gt 0 ]]; do
  case "$1" in
    --outdir|-o) OUTDIR="$2"; shift 2;;
    --) shift; while [[ $# -gt 0 ]]; do POSITIONAL_ARGS+=("$1"); shift; done;;
    -*) log_error "Unknown option: $1"; exit 1;;
    *) POSITIONAL_ARGS+=("$1"); shift;;
  esac
done

set -- "${POSITIONAL_ARGS[@]}"
CN="${1:-ca}"

# -----------------------------------------------------
# Main
# -----------------------------------------------------

mkdir -p "$OUTDIR"

CA_KEY="${OUTDIR}/ca.key"
CA_CRT="${OUTDIR}/ca.crt"

log_info "Generating CA private key..."
openssl genrsa -out "$CA_KEY" 4096

# Create temporary OpenSSL config for CA extensions
CA_CONFIG=$(mktemp)

{
  echo "[req]"
  echo "distinguished_name=req_distinguished_name"
  echo "x509_extensions=v3_ca"
  echo "prompt=no"

  echo "[req_distinguished_name]"
  echo "CN=${CN}"

  echo "[v3_ca]"
  echo "basicConstraints=critical, CA:TRUE"
  echo "keyUsage=critical, keyCertSign, cRLSign"
} > "$CA_CONFIG"

log_info "Generating CA certificate with extensions..."
openssl req -x509 -new \
  -key "$CA_KEY" \
  -days 3650 \
  -config "$CA_CONFIG" \
  -extensions v3_ca \
  -out "$CA_CRT"

log_info "Key:  $CA_KEY"
log_info "Cert: $CA_CRT"
