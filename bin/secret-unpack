#!/usr/bin/env python3
#
# Reads a JSON object from stdin containing a vault secret
# and unpacks the data in files where the keys become the
# file name and the values become the contents of the file.
#
# Where a key ends in ".base64" it's contents are decoded
# and the key has the ".base64" stripped.
#
# Usage:
# JSON | secret-unpack <FILE PATH>

import argparse
import base64
import json
import os
import sys
from pathlib import Path


def write(filename: str, buffer: str | bytes, mode: str) -> None:
    with open(filename, mode) as file:
        file.write(buffer)


def parse_args() -> argparse.Namespace:
    parser = argparse.ArgumentParser(
        description="Unpacks a JSON object and writes the contents to files."
    )
    parser.add_argument(
        "path", type=Path, required=True, help="Directory to write output to."
    )
    return parser.parse_args()


def main() -> None:
    args = parse_args()
    secret = json.load(sys.stdin)

    for key, value in secret.items():
        if key.endswith(".base64"):
            write(os.path.join(args.path, key[:-7]), base64.b64decode(value), "wb")
        else:
            write(os.path.join(args.path, key), value, "w")


if __name__ == "__main__":
    main()
