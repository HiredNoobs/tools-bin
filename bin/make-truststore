#!/usr/bin/env bash
#
# Usage: make-truststore <truststore-name> <cert1> [cert2 ...] [--outdir DIR]

THIS=$(realpath "$0")
HERE=$(dirname "$THIS")

source "$HERE/lib/logging.sh"

# -----------------------------------------------------
# Parsing args
# -----------------------------------------------------

OUTDIR="$PWD"

while [[ $# -gt 0 ]]; do
  case "$1" in
    --outdir|-o) OUTDIR="$2"; shift 2;;
    --) shift; while [[ $# -gt 0 ]]; do POSITIONAL_ARGS+=("$1"); shift; done;;
    -*) log_error "Unknown option: $1"; exit 1;;
    *) POSITIONAL_ARGS+=("$1"); shift;;
  esac
done

set -- "${POSITIONAL_ARGS[@]}"

TRUSTSTORE_NAME="$1"
shift 1
CERTS=("$@")

# -----------------------------------------------------
# Main
# -----------------------------------------------------

mkdir -p "$OUTDIR"

TS_FILE="${OUTDIR}/${TRUSTSTORE_NAME}.jks"
PASS_FILE="${OUTDIR}/truststore.pass"

if [[ -f "$PASS_FILE" ]]; then
  TRUSTSTORE_PASS=$(<"${OUTDIR}/truststore.pass")
else
  TRUSTSTORE_PASS=$(openssl rand -base64 48 | tr -dc 'A-Za-z0-9' | head -c 32)
  echo "$TRUSTSTORE_PASS" > "$PASS_FILE"
fi

if [ -f "$TS_FILE" ]; then
  log_info "Existing truststore found at $TS_FILE â€” removing it"
  rm -f "$TS_FILE"
fi

for CERT in "${CERTS[@]}"; do
  if [ ! -f "$CERT" ]; then
    log_error "Error: certificate file not found: $CERT"
    exit 1
  fi

  ALIAS=$(basename "$CERT" | sed 's/\.[^.]*$//')

  log_info "Importing $CERT as alias '$ALIAS'..."
  keytool -import \
    -alias "$ALIAS" \
    -file "$CERT" \
    -keystore "$TS_FILE" \
    -storepass "$TRUSTSTORE_PASS" \
    -noprompt
done

log_info "Truststore: $TS_FILE"
